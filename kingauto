#!/system/bin/sh
# KTSR by pedro (pedrozzz0 @ GitHub)

MODPATH=/data/adb/modules/KTSR

# Load libraries
. $MODPATH/libs/libktsr.sh

fullram=$((totalram * 20 / 100))

if [[ -e "/sdcard/KTSR/battcurrent.log" ]]; then
rm "/sdcard/KTSR/battcurrent.log"
fi

save_current(){
for i in /sys/class/*/*/constant_charge*; do
for x in /sys/class/*/*/current_max*; do
cat "$i" >> /sdcard/KTSR/battcurrent.log
done
cat "$x" >> /sdcard/KTSR/battcurrent.log
done
cat "/sys/class/qc_battery/restrict_cur" >> "/sdcard/KTSR/battcurrent.log"
}

current(){
for x in $(seq 1 10); do
cat "/sdcard/KTSR/battcurrent.log" | awk -v seq="$x" '{print $seq}'
done
}

default_current(){
for i in /sys/class/*/*/constant_charge*; do
for x in /sys/class/*/*/current_max*; do
write "$i" "$current"
done
write "$x" "$current"
done
write "/sys/class/qc_battery/restrict_cur" "$current"
}

thermal_current(){
for i in /sys/class/power_supply/*/constant_charge*; do
for x in /sys/class/*/*/current_max*; do
write "$i" "1800000"
done
write "$x" "1800000"
done
write "/sys/class/qc_battery/restrict_cur" "1800000"
}

save_current

(
while true; do
  if [[ "$(top -n 1 -d 1 | head -n 12 | grep -o -e 'netease' -e 'linegames' -e 'kleientertainment' -e 'agaming' -e 'generagames' -e 'chucklefish' -e 'astragon' -e 't2kgames' -e 't2ksports' -e 'turner' -e 'uplayonline' -e 'pubg' -e 'dreamotion' -e 'snailgames' -e 'dexintgames' -e 'haegin' -e 'panzerdog' -e 'igg' -e 'gtarcade' -e 'nexon' -e 'mame4droid' -e 'kakaogames' -e 'telltalegames' -e 'bandainamco' -e 'seleuco' -e 'innersloth' -e 'kiloo' -e 'imaginalis' -e 'refuelgames' -e 'scottgames' -e 'clickteam' -e 'minigames' -e 'headupgames' -e 'mobigames' -e 'callofduty' -e 'ubisoft' -e 'ppsspp' -e 'cf' -e 'feralinteractive' -e 'riotgames' -e 'joymax' -e 'deadeffect' -e 'wolvesinteractive' -e 'miniclip' -e 'playgendary' -e 'mojang' -e 'miHoYo' -e 'nekki' -e 'gamedevltd' -e 'netmarble' -e 'eyougame' -e 'yoozoogames' -e 'gameloft' -e 'garena' -e 'moontoon' -e 'legends' -e 'wildrift' -e 'activision' -e 'freefireth' -e 'konami' -e 'gamevil' -e 'battle' -e 'impact' -e 'gameloft' -e 'ppsspp' -e 'madfingergames' -e 'supercell' -e 'asphalt' -e 'ngame' -e 'fifamobile' -e 'blackdesertm' -e 'rockstargames' -e 'dhlove' -e 'criticalops' -e 'standoff2' -e 'firsttouchgames' | head -n 1)" ]]; then
  . $MODPATH/libs/libktsr.sh
  kmsg1 "----------------------------------------"
  kmsg  "User is playing. Applied gaming profile."
  kmsg1 "----------------------------------------"
  gaming
  sleep 40
  elif [[ "$(top -n 1 -d 1 | head -n 12 | grep -o -e 'whatsapp' -e 'musically' -e 'adobe' -e 'telegram' -e 'netflix' -e 'wemesh' -e 'discord' -e 'youtube' -e 'facebook' -e 'chrome' -e 'instagram' -e 'docs' | head -n 1)" ]]; then
  . $MODPATH/libs/libktsr.sh
  kmsg1 "-------------------------------------------------------------------"
  kmsg  "User is using social media, and etc apps. Applied balanced profile."
  kmsg1 "-------------------------------------------------------------------"
  balanced
  sleep 40
  elif [[ "$(top -n 1 -d 1 | head -n 12 | grep -o -e 'geekbench' -e 'androbench2' -e 'kinemaster' -e 'futuremark' -e 'cputhrottlingtest' -e 'camera' -e 'cam' -e 'snap' -e 'snapcam' | head -n 1)" ]]; then
  . $MODPATH/libs/libktsr.sh
  kmsg1 "----------------------------------------------------------------"
  kmsg  "User is running benchmark / heavy apps. Applied extreme profile."
  kmsg1 "----------------------------------------------------------------"
  extreme
  sleep 40
  elif [[ "$(cat /sys/class/leds/lcd-backlight/brightness)" ]] || [[ "$(cat /sys/class/backlight/panel*-backlight/brightness)" == "0" ]]; then
  . $MODPATH/libs/libktsr.sh
  kmsg1 "--------------------------------------------------------------------------"
  kmsg  "Device screen is turned off. Applied battery profile, extended check time."
  kmsg1 "--------------------------------------------------------------------------"
  battery
  sleep 300
  elif [[ "$bstatus" == "Charging" ]]; then
  . $MODPATH/libs/libktsr.sh
  kmsg1 "-----------------------------------------------------------------------------------------------------------"
  kmsg  "Device is charging, trying to reduce battery cycles by applying battery profile and extending check time..."
  kmsg1 "-----------------------------------------------------------------------------------------------------------"
  battery
  sleep 300
  elif [[ "$gbpercentage" -lt "20" ]] && [[ "$bstatus" == "Discharging" ]]; then
  . $MODPATH/libs/libktsr.sh
  kmsg1 "----------------------------------------------------------------------------------------------------------------"
  kmsg  "Device battery is lower than 20%, applied battery profile and extended check time to reduce battery comsumption."
  kmsg1 "----------------------------------------------------------------------------------------------------------------"
  battery
  sleep 300
  else
  . $MODPATH/libs/libktsr.sh
  kmsg1 "-----------------------------------------------------"
  kmsg  "No considerable usage found. Applied latency profile."
  kmsg1 "-----------------------------------------------------"
  latency
  sleep 30
 fi
done

if [[ $availram -lt $fullram ]] || [[ $availram -eq $fullram ]]; then
kmsg1 "----------------------------------------------------------------------"
kmsg  "Device ram is almost fully in use, dropping caches to free some RAM..."
kmsg1 "----------------------------------------------------------------------"
write "$vm/drop_caches" "3"
fi

if [[ $gbtemp -gt "46" ]] || [[ $gbtemp -eq "46" ]] && [[ $bstatus == "Charging" ]]; then
kmsg1 "---------------------------------------------------------------------------------"
kmsg  "Device is hot and charging, reducing max constant current to avoid overheating..."
kmsg1 "---------------------------------------------------------------------------------"
thermal_current

elif [[ $gbtemp -lt "40" ]] || [[ $gbtemp -eq "40" ]] && [[ $bstatus == "Charging" ]]; then
kmsg1 "-----------------------------------------------------------------------"
kmsg  "Device is less hot now, changing max constant current to default now..."
kmsg1 "-----------------------------------------------------------------------"
default_current
fi
)&