#!/system/bin/sh
# KTSR by Pedro (pedrozzz0 @ GitHub)
# Credits: HafizZiq
# If you wanna use it as part of your project, please maintain the credits to it respective's author(s).

MODPATH=/data/adb/modules/KTSR

# Load libraries
. "$MODPATH"/libs/libktsr.sh

full_ram=$((total_ram * 20 / 100))

# Get screen state
get_scrn_state(){
	scrn_state=$(dumpsys power | grep state=O | cut -d "=" -f 2)
	if [[ "$scrn_state" == "ON" ]]; then 
	is_scrn_on=1
	else 
	is_scrn_on=0
	fi
	}
	
(
while true; do
  if [[ "$(top -n 1 -d 1 | head -n 12 | grep -o -e 'netease' -e 'com2us' -e 'zuuks' -e 'junegaming' -e 'junesoftware' -e 'sozap' -e 'dotemu' -e 'playrisedigital' -e 'playables' -e 'rockstar' -e 'blackpanther' -e 'noodlecake' -e 'linegames' -e 'kleientertainment' -e 'agaming' -e 'generagames' -e 'chucklefish' -e 'astragon' -e 't2kgames' -e 't2ksports' -e 'turner' -e 'uplayonline' -e 'pubg' -e 'dreamotion' -e 'snailgames' -e 'dexintgames' -e 'haegin' -e 'panzerdog' -e 'igg' -e 'gtarcade' -e 'nexon' -e 'mame4droid' -e 'kakaogames' -e 'telltalegames' -e 'bandainamco' -e 'seleuco' -e 'innersloth' -e 'kiloo' -e 'imaginalis' -e 'refuelgames' -e 'scottgames' -e 'clickteam' -e 'minigames' -e 'headupgames' -e 'mobigames' -e 'callofduty' -e 'ubisoft' -e 'ppsspp' -e 'cf' -e 'feralinteractive' -e 'riotgames' -e 'joymax' -e 'deadeffect' -e 'wolvesinteractive' -e 'miniclip' -e 'playgendary' -e 'mojang' -e 'miHoYo' -e 'nekki' -e 'gamedevltd' -e 'netmarble' -e 'eyougame' -e 'yoozoogames' -e 'gameloft' -e 'garena' -e 'moontoon' -e 'legends' -e 'wildrift' -e 'activision' -e 'freefireth' -e 'konami' -e 'gamevil' -e 'battle' -e 'impact' -e 'gameloft' -e 'ppsspp' -e 'madfingergames' -e 'supercell' -e 'asphalt' -e 'ngame' -e 'fifamobile' -e 'blackdesertm' -e 'rockstargames' -e 'dhlove' -e 'criticalops' -e 'standoff2' -e 'firsttouchgames' | head -n 1)" ]]; then
  . "$MODPATH"/libs/libktsr.sh
  kmsg "User is playing, applied gaming profile"
  kmsg3 ""
  gaming
  sleep 30
  elif [[ "$(top -n 1 -d 1 | head -n 12 | grep -o -e 'whatsapp' -e 'musically' -e 'adobe' -e 'telegram' -e 'netflix' -e 'wemesh' -e 'discord' -e 'youtube' -e 'facebook' -e 'chrome' -e 'instagram' -e 'docs' | head -n 1)" ]]; then
  . "$MODPATH"/libs/libktsr.sh
  kmsg "User is using social media, and etc apps. Applied balanced profile"
  kmsg3 ""
  balanced
  sleep 30
  elif [[ "$(top -n 1 -d 1 | head -n 12 | grep -o -e 'geekbench' -e 'androbench2' -e 'kinemaster' -e 'futuremark' -e 'cputhrottlingtest' -e 'camera' -e 'cam' -e 'snap' -e 'snapcam' | head -n 1)" ]]; then
  . "$MODPATH"/libs/libktsr.sh
  kmsg "User is running benchmark / heavy apps. Applied extreme profile"
  kmsg3 ""
  extreme
  sleep 30
  elif [[ "$(cat /sys/class/leds/lcd-backlight/brightness)" ]] || [[ "$(cat /sys/class/backlight/panel*-backlight/brightness)" == "0" ]] || [[ get_scrn_state && $is_scrn_on == "0" ]]; then
  . "$MODPATH"/libs/libktsr.sh
  kmsg "Device screen is turned off. Applied battery profile, extended script check time"
  kmsg3 ""
  battery
  sleep 100
  elif [[ "$bstatus" == "Charging" ]]; then
  . "$MODPATH"/libs/libktsr.sh
  kmsg "Device is charging, trying to reduce battery cycles by applying battery profile and extending check time"
  kmsg3 ""
  battery
  sleep 100
  elif [[ "$gbpercentage" -le "20" ]] && [[ "$bstatus" == "Discharging" ]]; then
  . "$MODPATH"/libs/libktsr.sh
  kmsg "Device battery is lower than 20%, applied battery profile and extended script check time to reduce battery comsumption"
  kmsg3 ""
  battery
  sleep 100
  else
  . "$MODPATH"/libs/libktsr.sh
  kmsg "No considerable usage found. Applied latency profile"
  kmsg3 ""
  latency
  sleep 15
 fi
done

if [[ $avail_ram -lt $full_ram ]] || [[ $avail_ram -eq $full_ram ]]; then
kmsg "Device ram is almost fully in use, dropping caches to free some RAM"
kmsg3 ""
write "$vm/drop_caches" "3"
fi
)&