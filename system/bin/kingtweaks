#!/system/bin/sh
# Written by Draco (tytydraco @github).
# Modified by Pedrozzz (pedroginkgo @telegram).

mkdir /sdcard/KTS
LOG=/sdcard/KTS/KTS.log
rm $LOG

# Log in white and continue (unnecessary)
kmsg() {
	echo -e "[*] `date +%Y-%m-%d.%H:%M:%S` $@" >> $LOG
	echo -e "[*] `date +%Y-%m-%d.%H:%M:%S` $@"
}

write() {
	# Bail out if file does not exist
	[[ ! -f "$1" ]] && return 1

	# Fetch the current key value
	local curval=`cat "$1" 2> /dev/null`
	
	# Bail out if value is already set
	[[ "$curval" == "$2" ]] && return 1
	
	# Make file writable in case it is not already
	chmod +w "$1" 2> /dev/null

	# Write the new value and bail if there's an error
	if ! echo "$2" > "$1" 2> /dev/null
	then
		kmsg "Failed: $1 -> $2"
		return 1
	fi

	# Log the success
	kmsg "$1 $curval -> $2"
}

vibrate_cmode() {
if [ -e /sys/class/leds/vibrator/duration ] &&  [ -e /sys/class/leds/vibrator/activate ]
then
echo 500 > /sys/class/leds/vibrator/duration && echo 1 > /sys/class/leds/vibrator/activate
fi
}

# Check for root permissions and bail if not granted
if [[ "$(id -u)" -ne 0 ]]
then
	kmsg "No root permissions. Exiting."
	exit 1
fi

setprop persist.spectrum.kernel "KTS Reborn"
setprop spectrum.support "1"

boot_run_once=false
spectrum_mode=$(getprop persist.spectrum.profile)
[ -z "$spectrum_mode" ] && setprop persist.spectrum.profile "0"

while true
do
sleep 3
if $boot_run_once
then
[ "$(getprop persist.spectrum.profile)" == "$spectrum_mode" ] && continue
else
boot_run_once=true
fi
spectrum_mode=$(getprop persist.spectrum.profile)
case "$spectrum_mode" in
     # Balance Profile
        "0") {
        	kmsg ""
kmsg "---------------------------------------------------------- Info --------------------------------------------------------------------------------------------"
kmsg "                                            üïõ Date of execution: $(date)                                                                                   "
kmsg "                                            üîß Device kernel: `uname -a`                                                                                    "
kmsg "                                            üõ†Ô∏è SOC: $(getprop ro.board.platform)                                                                            "
kmsg "                                            ‚öôÔ∏è SDK: $(getprop ro.build.version.sdk)                                                                         "
kmsg "                                            üÖ∞Ô∏èndroid Version: $(getprop ro.build.version.release)                                                           "
kmsg "                                            üì± Device: $(getprop ro.product.odm.model)                                                                      "
kmsg "                                            üëë KTS Version: 1.8.1                                                                                           "
kmsg "------------------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg ""

	kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
	kmsg "                                        ENABLING BALANCE PROFILE...                                                                              "
	kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
	
	# Duration in nanoseconds of one scheduling period
SCHED_PERIOD="$((1 * 1000 * 1000))"

# How many tasks should we have at a maximum in one scheduling period
SCHED_TASKS="8"

# Maximum unsigned integer size in C
UINT_MAX="4294967295"
        	
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING THERMAL-ENGINE AND PERFD...                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
        	
# Enable throttling and perfd
start thermal-engine
start perfd
        	
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING I/O SCHEDULER...                                                                              "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# I/O Scheduler Tweaks.
for queue in /sys/block/*/queue/
do
 avail_scheds="$(cat "${queue}scheduler")"
 for sched in zen anxiety cfq noop kyber bfq mq-deadline none
 do
  if [[ "$avail_scheds" == *"$sched"* ]]
  then
   write "${queue}scheduler" "$sched"
   break
  fi
 done
 write "${queue}add_random" 0
 write "${queue}iostats" 0
 write "${queue}read_ahead_kb" 128
 write "${queue}nr_requests" 64
done

# Reserve 90% IO bandwith for foreground tasks
if [[ -d "/dev/blkio" ]]
then
write "/dev/blkio/blkio.weight" "1000"
write "/dev/blkio/blkio.leaf_weight" "1000"
write "/dev/blkio/background/blkio.weight" "100"
write "/dev/blkio/background/blkio.leaf_weight" "100"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                         TWEAKING CPU...                                                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# CPU Tweaks
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/
do
avail_govs=`cat "${cpu}scaling_available_governors"`
if [[ "$avail_govs" == *"schedutil"* ]]
then
write "${cpu}scaling_governor" schedutil
write "${cpu}schedutil/up_rate_limit_us" "$((SCHED_PERIOD / 1000))"
write "${cpu}schedutil/down_rate_limit_us" "$((4 * SCHED_PERIOD / 1000))"
write "${cpu}schedutil/iowait_boost_enable" "0"
write "${cpu}schedutil/rate_limit_us" "$((SCHED_PERIOD / 1000))"
write "${cpu}schedutil/hispeed_load" "85"
write "${cpu}schedutil/hispeed_freq" "$UINT_MAX"
elif [[ "$avail_govs" == *"interactive"* ]]
then
write "${cpu}scaling_governor" interactive
write "${cpu}interactive/timer_rate" "$((SCHED_PERIOD / 1000))"
write "${cpu}interactive/timer_slack" "-1"
write "${cpu}interactive/boost" "0"
write "${cpu}interactive/boostpulse" "0"
write "${cpu}interactive/fast_ramp_down" "0"
write "${cpu}interactive/sampling_rate" "10000"
write "${cpu}interactive/sampling_rate_min" "10000"
write "${cpu}interactive/min_sample_time" "$((SCHED_PERIOD / 1000))"
write "${cpu}interactive/go_hispeed_load" "85"
write "${cpu}interactive/hispeed_freq" "$UINT_MAX"
fi
done

write "/sys/devices/system/cpu/cpu1/online" "1"
write "/sys/devices/system/cpu/cpu2/online" "1"
write "/sys/devices/system/cpu/cpu5/online" "1"
write "/sys/devices/system/cpu/cpu6/online" "1"

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING GPU...                                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
	
# GPU Tweaks.
for gpu in /sys/class/kgsl/kgsl-3d0/
do
if [[ -d "/sys/class/kgsl/kgsl-3d0" ]]
then
write "${gpu}throttling" "1"
write "${gpu}thermal_pwrlevel" "0"
write "${gpu}devfreq/adrenoboost" "0"
write "${gpu}force_no_nap" "0"
write "${gpu}bus_split" "1"
write "${gpu}devfreq/min_freq" "100000000"
write "${gpu}devfreq/max_freq" "600000000"
write "${gpu}default_pwrlevel" `cat /sys/class/kgsl/kgsl-3d0/min_pwrlevel`
write "${gpu}force_bus_on" "0"
write "${gpu}force_clk_on" "0"
write "${gpu}force_rail_on" "0"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING ADRENO IDLER...                                                                               "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable adreno idler
if [[ -d "/sys/module/adreno_idler" ]]
then
write "/sys/module/adreno_idler/parameters/adreno_idler_active" "Y"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING LMK...                                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Low Memory Killer tweaks.
for lmk in /sys/module/lowmemorykiller/parameters/
do
if [[ -d "/sys/module/lowmemorykiller" ]]
then
write "${lmk}enable_lmk" "1"
write "${lmk}enable_adaptive_lmk" "1"
write "${lmk}minfree" "21816,29088,36360,43632,50904,65448"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING DEBUGGERS...                                                                                 "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Disable debuggers.
for bl in /sys/module/bluetooth/parameters/
do
if [[ -d /sys/module/bluetooth ]]
then
write "${bl}disable_ertm" "Y"
write "${bl}disable_esco" "Y"
fi
done

write "/sys/module/earlysuspend/parameters/debug_mask" "0"
write "/sys/module/alarm/parameters/debug_mask" "0"
write "/sys/module/alarm_dev/parameters/debug_mask" "0"
write "/sys/module/binder/parameters/debug_mask" "0"
write "/sys/devices/system/edac/cpu/log_ce" "0"
write "/sys/devices/system/edac/cpu/log_ue" "0"
write "/sys/module/binder/parameters/debug_mask" "0"
write "/sys/module/debug/parameters/enable_event_log" "0"
write "/sys/module/dwc3/parameters/ep_addr_rxdbg_mask" "0"
write "/sys/module/dwc3/parameters/ep_addr_txdbg_mask" "0"
write "/sys/module/edac_core/parameters/edac_mc_log_ce" "0"
write "/sys/module/edac_core/parameters/edac_mc_log_ue" "0"
write "/sys/module/glink/parameters/debug_mask" "0"
write "/sys/module/hid_apple/parameters/fnmode" "0"
write "/sys/module/hid_magicmouse/parameters/emulate_3button" "N"
write "/sys/module/hid_magicmouse/parameters/emulate_scroll_wheel" "N"
write "/sys/module/ip6_tunnel/parameters/log_ecn_error" "N"
write "/sys/module/lowmemorykiller/parameters/debug_level" "0"
write "/sys/module/mdss_fb/parameters/backlight_dimmer" "N"
write "/sys/module/msm_show_resume_irq/parameters/debug_mask" "0"
write "/sys/module/msm_smd/parameters/debug_mask" "0"
write "/sys/module/msm_smem/parameters/debug_mask" "0"
write "/sys/module/otg_wakelock/parameters/enabled" "N" 
write "/sys/module/service_locator/parameters/enable" "0"
write "/sys/module/sit/parameters/log_ecn_error" "N"
write "/sys/module/smem_log/parameters/log_enable" "0"
write "/sys/module/smp2p/parameters/debug_mask" "0"
write "/sys/module/touch_core_base/parameters/debug_mask" "0"
write "/sys/module/usb_bam/parameters/enable_event_log" "0"
write "/sys/module/printk/parameters/console_suspend" "Y"
write "/proc/sys/debug/exception-trace" "0"
write "/proc/sys/kernel/printk" "0 0 0 0"
write "/proc/sys/kernel/compat-log" "0"

if [ -e /sys/module/logger/parameters/log_mode ]
then
write "/sys/module/logger/parameters/log_mode" "2"
fi

if [ -e /sys/module/printk/parameters/console_suspend ] 
then
write "/sys/module/printk/parameters/console_suspend" "Y"
fi

for i in $(find /sys/ -name debug_mask)
do
write "$i" "0"
done

for i in $(find /sys/ -name debug_level)
do
write "$i" "0"
done

for i in $(find /sys/ -name edac_mc_log_ce)
do
write "$i" "0"
done

for i in $(find /sys/ -name edac_mc_log_ue)
do
write "$i" "0"
done

for i in $(find /sys/ -name enable_event_log) 
do
write "$i" "0"
done

for i in $(find /sys/ -name log_ecn_error)
do
write "$i" "N"
done

for i in $(find /sys/ -name snapshot_crashdumper)
do
write "$i" "0"
done

# =========
# FIX DEEPSLEEP
# =========
for i in $(ls /sys/class/scsi_disk/)
do
lock_val 'temporary none' '/sys/class/scsi_disk/$i/cache_type'
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING SCHEDTUNE TWEAKS...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Schedtune Tweaks
for st in /dev/stune
do
if [[ -d "/dev/stune" ]]
then
write "${st}/background/schedtune.boost" "0"
write "${st}/background/schedtune.prefer_idle" "0"

write "${st}/foreground/schedtune.boost" "1"
write "${st}/foreground/schedtune.prefer_idle" "1"

write "${st}/rt/schedtune.boost" "0"
write "${st}/rt/schedtune.prefer_idle" "0"

write "${st}/top-app/schedtune.boost" "5"
write "${st}/top-app/schedtune.prefer_idle" "1"

write "${st}/schedtune.boost" "0"
write "${st}/schedtune.prefer_idle" "0"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING FS TWEAKS...                                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# FS tweaks.
for fs in /proc/sys/fs/
do
if [[ -d "/proc/sys/fs" ]]
then
write "${fs}dir-notify-enable" "0"
write "${fs}lease-break-time" "25"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING DYNAMIC FSYNC...                                                                              "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable dynamic_fsync.
if [[ -e /sys/kernel/dyn_fsync/dyn_fsync_active ]]
then
chmod 666 /sys/kernel/dyn_fsync/dyn_fsync_active
chown root /sys/kernel/dyn_fsync/dyn_fsync_active
write "/sys/kernel/dyn_fsync/dyn_fsync_active" "1"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING SCHEDULER TWEAKS...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Scheduler tweaks. 
for sched in /sys/kernel/debug/
do
if [[ -e "/sys/kernel/debug/sched_features" ]]
then
write "${sched}sched_features" "NEXT_BUDDY"
write "${sched}sched_features" "TTWU_QUEUE"
fi
done
 
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING ONEPLUS CHAIN...                                                                             "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# OP Chain disable.
for opc in /sys/module/opchain/parameters/
do
if [[ -d "/sys/module/opchain" ]]
then
write "${opc}chain_on" "0"
fi
done
 
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING KERNEL SETTINGS...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Tweak some kernel settings to improve overall performance.
for kts in /proc/sys/kernel/
do
if [[ -d "/proc/sys/kernel" ]] 
then
write "${kts}sched_child_runs_first" "1"
write "${kts}perf_cpu_time_max_percent" "5"
write "${kts}sched_autogroup_enabled" "1"
write "${kts}random/read_wakeup_threshold" "64"
write "${kts}random/write_wakeup_threshold" "256"
write "${kts}sched_tunable_scaling" "0"
write "${kts}sched_latency_ns" "$SCHED_PERIOD"
write "${kts}sched_min_granularity_ns" "$((SCHED_PERIOD / SCHED_TASKS))"
write "${kts}sched_wakeup_granularity_ns" "$((SCHED_PERIOD / 2))"
write "${kts}sched_migration_cost_ns" "5000000"
write "${kts}sched_min_task_util_for_colocation" "0"
write "${kts}sched_nr_migrate" "8"
write "${kts}sched_schedstats" "0"
write "${kts}printk_devkmsg" "off"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          SETTING MIN AND MAX CPU FREQUENCY...                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Set min and max clocks.
for minclk in /sys/devices/system/cpu/cpufreq/policy*/
do
if [[ -e "${minclk}scaling_min_freq" ]]
then
write "${minclk}scaling_min_freq" "300000"
write "${minclk}scaling_max_freq" "20000000"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING EFFICIENT CPUSET...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Efficient CPU Set.
for cs in /dev/cpuset/
do
if [[ -d "/dev/cpuset" ]]
then
write "${cs}game/cpus" "0-7"
write "${cs}gamelite/cpus" "0-3,4-7"
write "${cs}camera-daemon/cpus" "0-7"
write "${cs}vr/cpus" "0-7"
write "${cs}top-app/cpus" "0-7"
write "${cs}audio-app/cpus" "1-2"
write "${cs}background/cpus" "0-3"
write "${cs}foreground/cpus" "0-7"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING VM TWEAKS...                                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# VM settings to improve overall user experience and smoothness.
for vm in /proc/sys/vm/
do
if [[ -d "/proc/sys/vm" ]]
then
write "${vm}drop_caches" "3"
write "${vm}dirty_background_ratio" "10"
write "${vm}dirty_ratio" "30"
write "${vm}dirty_expire_centisecs" "3000"
write "${vm}dirty_writeback_centisecs" "3000"
write "${vm}page-cluster" "0"
write "${vm}stat_interval" "10"
write "${vm}swap_ratio_enable" "1"
write "${vm}swap_ratio" "100"
write "${vm}swappiness" "100"
write "${vm}vfs_cache_pressure" "200"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING MSM THERMAL SETTINGS...                                                                       "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# MSM thermal
if [[ -d "/sys/module/msm_thermal" ]]
then
write /sys/module/msm_thermal/vdd_restriction/enabled "0"
write /sys/module/msm_thermal/core_control/enabled "1"
write /sys/module/msm_thermal/parameters/enabled "Y"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING POWER EFFICIENT WORKQUEUE...                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable power efficient workqueue.
for wqpw in /sys/module/workqueue/parameters/
do
if [[ -d "/sys/module/workqueue" ]]
then 
write "${wqpw}power_efficient" "Y"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          FIXING DOUBLE TAP TO WAKEUP...                                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Fix DT2W.
for dt in /sys/touchpanel/
do
if [[ -d "/sys/touchpanel" ]]
then
write "${dt}double_tap" "1"
fi
done

if [[ -e "/proc/tp_gesture" ]]
then
write "/proc/tp_gesture" "1"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING MSM TOUCH BOOST...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Disable touch boost on balance and battery profile.
if [[ -e /sys/module/msm_performance/parameters/touchboost ]]
then
write "/sys/module/msm_performance/parameters/touchboost" "0"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING INTERNET TWEAKS...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Internet Tweaks
for tcp in /proc/sys/net/ipv4/
do
if [[ -d "/proc/sys/net" ]]
then
write "${tcp}ip_no_pmtu_disc" "0"
write "${tcp}tcp_ecn" "1"
write "${tcp}tcp_timestamps" "0"
write "${tcp}route.flush" "1"
write "${tcp}tcp_rfc1337" "1"
write "${tcp}tcp_tw_reuse" "1"
write "${tcp}tcp_sack" "1"
write "${tcp}tcp_fack" "1"
write "${tcp}tcp_fastopen" "3"
write "${tcp}tcp_tw_recycle" "1"
write "${tcp}tcp_syncookies" "0"
write "${tcp}tcp_window_scaling" "1"
write "${tcp}tcp_keepalive_probes" "10"
write "${tcp}tcp_keepalive_intvl" "30"
write "${tcp}tcp_fin_timeout" "30"
write "${tcp}tcp_low_latency" "1"
fi
done

# Tweak and decrease tx_queue_len default stock value(s) for less amount of generated bufferbloat and for gaining slightly faster network speed and performance;
for i in $(find /sys/class/net -type l)
do
write "$i/tx_queue_len" "128"
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          CALIBRATING TOUCH...                                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Touch calibration
panel=$(cat /sys/class/graphics/fb0/modes)
if [[ "${panel:5:1}" == "x" ]]
then
panel=${panel:2:3}
else
panel=${panel:2:4}
fi
  
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING LPM...                                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable LPM in balanced / battery profile
for lpm in /sys/module/lpm_levels/parameters/
do
if [[ -d /sys/module/lpm_levels ]]
then
write "${lpm}sleep_disabled" "N"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING FORCE FAST CHARGING...                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable Fast Charging Rate
for ffc in /sys/kernel/fast_charge/
do
if [[ -e "/sys/kernel/fast_charge/force_fast_charge" ]]
then
write "${ffc}force_fast_charge" "1"
fi
done
  
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          KILLING GMS PROCESSES...                                                                               "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# GMS blocker 1.2 by @pedroginkgo
busybox killall -9 com.google.android.gms
busybox killall -9 com.google.android.gms.persistent
busybox killall -9 com.google.process.gapps
busybox killall -9 com.google.android.gsf
busybox killall -9 com.google.android.gsf.persistent

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                     BALANCE PROFILE APPLIED WITH SUCCESS.                                                                       "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
vibrate_cmode
};;
    # Performance Profile
        "1") {
        	kmsg ""
kmsg "---------------------------------------------------------- Info --------------------------------------------------------------------------------------------"
kmsg "                                            üïõ Date of execution: $(date)                                                                                   "
kmsg "                                            üîß Device kernel: `uname -a`                                                                                    "
kmsg "                                            üõ†Ô∏è SOC: $(getprop ro.board.platform)                                                                            "
kmsg "                                            ‚öôÔ∏è SDK: $(getprop ro.build.version.sdk)                                                                         "
kmsg "                                            üÖ∞Ô∏èndroid Version: $(getprop ro.build.version.release)                                                           "
kmsg "                                            üì± Device: $(getprop ro.product.odm.model)                                                                      "
kmsg "                                            üëë KTS Version: 1.8.1                                                                                           "
kmsg "------------------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg ""

	kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
	kmsg "                                    ENABLING PERFORMANCE PROFILE...                                                                              "
	kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
       
        	# Duration in nanoseconds of one scheduling period
SCHED_PERIOD="$((1 * 1000 * 1000))"

# How many tasks should we have at a maximum in one scheduling period
SCHED_TASKS="8"

# Maximum unsigned integer size in C
UINT_MAX="4294967295"

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING THERMAL-ENGINE AND ENABLING PERFD...                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Disable throttling and enable perfd.
stop thermal-engine
start perfd

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING CPU INPUT BOOST...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Caf CPU Boost
for caf in /sys/module/cpu_boost/parameters/
do
if [[ -d "/sys/module/cpu_boost/parameters" ]]
then
write "${caf}input_boost_freq" "0:$UINT_MAX 1:$UINT_MAX 2:$UINT_MAX 3:$UINT_MAX 4:$UINT_MAX 5:$UINT_MAX 6:$UINT_MAX 7:$UINT_MAX"
write "${caf}input_boost_ms" "64"
fi
done

# CPU Boost
for cib in /sys/module/cpu_input_boost/parameters/
do
if [[ -d "/sys/module/cpu_input_boost" ]]
then
write "${cib}input_boost_duration" "64"
write "${cib}input_boost_freq_hp" "$UINT_MAX"
write "${cib}input_boost_freq_lp" "$UINT_MAX"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING I/O SCHEDULER...                                                                              "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# I/O Scheduler Tweaks.
for queue in /sys/block/*/queue/
do
 avail_scheds="$(cat "${queue}scheduler")"
 for sched in zen anxiety cfq noop kyber bfq mq-deadline none
 do
  if [[ "$avail_scheds" == *"$sched"* ]]
  then
   write "${queue}scheduler" "$sched"
   break
  fi
 done
 write "${queue}add_random" 0
 write "${queue}iostats" 0
 write "${queue}read_ahead_kb" 128
 write "${queue}nr_requests" 64
done

# Reserve 90% IO bandwith for foreground tasks
if [[ -d "/dev/blkio" ]]
then
write "/dev/blkio/blkio.weight" "1000"
write "/dev/blkio/blkio.leaf_weight" "1000"
write "/dev/blkio/background/blkio.weight" "100"
write "/dev/blkio/background/blkio.leaf_weight" "100"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                         TWEAKING CPU...                                                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# CPU Tweaks
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/
do
avail_govs=`cat "${cpu}scaling_available_governors"`
if [[ "$avail_govs" == *"schedutil"* ]]
then
write "${cpu}scaling_governor" schedutil
write "${cpu}schedutil/up_rate_limit_us" "$((SCHED_PERIOD / 1000))"
write "${cpu}schedutil/down_rate_limit_us" "$((4 * SCHED_PERIOD / 1000))"
write "${cpu}schedutil/iowait_boost_enable" "1"
write "${cpu}schedutil/rate_limit_us" "$((SCHED_PERIOD / 1000))"
write "${cpu}schedutil/hispeed_load" "80"
write "${cpu}schedutil/hispeed_freq" "$UINT_MAX"
elif [[ "$avail_govs" == *"interactive"* ]]
then
write "${cpu}scaling_governor" interactive
write "${cpu}interactive/timer_rate" "$((SCHED_PERIOD / 1000))"
write "${cpu}interactive/timer_slack" "-1"
write "${cpu}interactive/boost" "1"
write "${cpu}interactive/boostpulse" "1"
write "${cpu}interactive/boostpulse_duration" "640000"
write "${cpu}interactive/fast_ramp_down" "1"
write "${cpu}interactive/sampling_rate" "5000"
write "${cpu}interactive/sampling_rate_min" "5000"
write "${cpu}interactive/min_sample_time" "$((SCHED_PERIOD / 1000))"
write "${cpu}interactive/go_hispeed_load" "80"
write "${cpu}interactive/hispeed_freq" "$UINT_MAX"
fi
done
	
write "/sys/devices/system/cpu/cpu1/online" "1"
write "/sys/devices/system/cpu/cpu2/online" "1"
write "/sys/devices/system/cpu/cpu5/online" "1"
write "/sys/devices/system/cpu/cpu6/online" "1"

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING GPU...                                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
	
# GPU Tweaks.
for gpu in /sys/class/kgsl/kgsl-3d0/
do
if [[ -d "/sys/class/kgsl/kgsl-3d0" ]]
then
write "${gpu}throttling" "1"
write "${gpu}thermal_pwrlevel" "1"
write "${gpu}devfreq/adrenoboost" "0"
write "${gpu}force_no_nap" "0"
write "${gpu}bus_split" "1"
write "${gpu}devfreq/min_freq" "100000000"
write "${gpu}devfreq/max_freq" "950000000"
write "${gpu}default_pwrlevel" `cat /sys/class/kgsl/kgsl-3d0/min_pwrlevel`
write "${gpu}force_bus_on" "0"
write "${gpu}force_clk_on" "0"
write "${gpu}force_rail_on" "0"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING ADRENO IDLER...                                                                               "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable adreno idler
if [[ -d "/sys/module/adreno_idler" ]]
then
write "/sys/module/adreno_idler/parameters/adreno_idler_active" "Y"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING LMK...                                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Low Memory Killer Tweaks.
for lmk in /sys/module/lowmemorykiller/parameters/
do
if [[ -d "/sys/module/lowmemorykiller" ]]
then
write "${lmk}enable_lmk" "1"
write "${lmk}enable_adaptive_lmk" "1"
write "${lmk}minfree" "21816,29088,36360,43632,50904,65448"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING DEBUGGERS...                                                                                 "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Disable debuggers.
for bl in /sys/module/bluetooth/parameters/
do
if [[ -d /sys/module/bluetooth ]]
then
write "${bl}disable_ertm" "Y"
write "${bl}disable_esco" "Y"
fi
done

write "/sys/module/earlysuspend/parameters/debug_mask" "0"
write "/sys/module/alarm/parameters/debug_mask" "0"
write "/sys/module/alarm_dev/parameters/debug_mask" "0"
write "/sys/module/binder/parameters/debug_mask" "0"
write "/sys/devices/system/edac/cpu/log_ce" "0"
write "/sys/devices/system/edac/cpu/log_ue" "0"
write "/sys/module/binder/parameters/debug_mask" "0"
write "/sys/module/debug/parameters/enable_event_log" "0"
write "/sys/module/dwc3/parameters/ep_addr_rxdbg_mask" "0"
write "/sys/module/dwc3/parameters/ep_addr_txdbg_mask" "0"
write "/sys/module/edac_core/parameters/edac_mc_log_ce" "0"
write "/sys/module/edac_core/parameters/edac_mc_log_ue" "0"
write "/sys/module/glink/parameters/debug_mask" "0"
write "/sys/module/hid_apple/parameters/fnmode" "0"
write "/sys/module/hid_magicmouse/parameters/emulate_3button" "N"
write "/sys/module/hid_magicmouse/parameters/emulate_scroll_wheel" "N"
write "/sys/module/ip6_tunnel/parameters/log_ecn_error" "N"
write "/sys/module/lowmemorykiller/parameters/debug_level" "0"
write "/sys/module/mdss_fb/parameters/backlight_dimmer" "N"
write "/sys/module/msm_show_resume_irq/parameters/debug_mask" "0"
write "/sys/module/msm_smd/parameters/debug_mask" "0"
write "/sys/module/msm_smem/parameters/debug_mask" "0"
write "/sys/module/otg_wakelock/parameters/enabled" "N" 
write "/sys/module/service_locator/parameters/enable" "0"
write "/sys/module/sit/parameters/log_ecn_error" "N"
write "/sys/module/smem_log/parameters/log_enable" "0"
write "/sys/module/smp2p/parameters/debug_mask" "0"
write "/sys/module/touch_core_base/parameters/debug_mask" "0"
write "/sys/module/usb_bam/parameters/enable_event_log" "0"
write "/sys/module/printk/parameters/console_suspend" "Y"
write "/proc/sys/debug/exception-trace" "0"
write "/proc/sys/kernel/printk" "0 0 0 0"
write "/proc/sys/kernel/compat-log" "0"

if [ -e /sys/module/logger/parameters/log_mode ]
then
write "/sys/module/logger/parameters/log_mode" "2"
fi

if [ -e /sys/module/printk/parameters/console_suspend ] 
then
write "/sys/module/printk/parameters/console_suspend" "Y"
fi

for i in $(find /sys/ -name debug_mask)
do
write "$i" "0"
done

for i in $(find /sys/ -name debug_level)
do
write "$i" "0"
done

for i in $(find /sys/ -name edac_mc_log_ce)
do
write "$i" "0"
done

for i in $(find /sys/ -name edac_mc_log_ue)
do
write "$i" "0"
done

for i in $(find /sys/ -name enable_event_log) 
do
write "$i" "0"
done

for i in $(find /sys/ -name log_ecn_error)
do
write "$i" "N"
done

for i in $(find /sys/ -name snapshot_crashdumper)
do
write "$i" "0"
done

# =========
# FIX DEEPSLEEP
# =========
for i in $(ls /sys/class/scsi_disk/)
do
lock_val 'temporary none' '/sys/class/scsi_disk/$i/cache_type'
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING SCHEDTUNE TWEAKS...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Schedtune Tweaks
for st in /dev/stune
do
if [[ -d "/dev/stune" ]]
then
write "${st}/background/schedtune.boost" "1"
write "${st}/background/schedtune.prefer_idle" "0"

write "${st}/foreground/schedtune.boost" "10"
write "${st}/foreground/schedtune.prefer_idle" "1"

write "${st}/rt/schedtune.boost" "0"
write "${st}/rt/schedtune.prefer_idle" "0"

write "${st}/top-app/schedtune.boost" "40"
write "${st}/top-app/schedtune.prefer_idle" "1"

write "${st}/schedtune.boost" "0"
write "${st}/schedtune.prefer_idle" "0"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING FS TWEAKS...                                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# FS Tweaks.
for fs in /proc/sys/fs/
do
if [[ -d "/proc/sys/fs" ]]
then
write "${fs}dir-notify-enable" "0"
write "${fs}lease-break-time" "25"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING DYNAMIC FSYNC...                                                                              "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable dynamic_fsync.
# Enable dynamic_fsync.
if [[ -e /sys/kernel/dyn_fsync/dyn_fsync_active ]]
then
chmod 666 /sys/kernel/dyn_fsync/dyn_fsync_active
chown root /sys/kernel/dyn_fsync/dyn_fsync_active
write "/sys/kernel/dyn_fsync/dyn_fsync_active" "1"
fi


kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING SCHEDULER TWEAKS...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Scheduler features.
for sched in /sys/kernel/debug/
do
if [[ -e "/sys/kernel/debug/sched_features" ]]
then
write "${sched}sched_features" "NEXT_BUDDY"
write "${sched}sched_features" "TTWU_QUEUE"
write "${sched}sched_features" "NO_GENTLE_FAIR_SLEEPERS"
fi
done
	
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING ONEPLUS CHAIN...                                                                             "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# OP Tweaks
for opc in /sys/module/opchain/parameters/
do
if [[ -d "/sys/module/opchain" ]]
then
write "${opc}chain_on" "0"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING KERNEL SETTINGS...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Tweak some kernel settings to improve overall performance.
for kts in /proc/sys/kernel/
do
if [[ -d "/proc/sys/kernel" ]] 
then
write "${kts}sched_child_runs_first" "1"
write "${kts}perf_cpu_time_max_percent" "5"
write "${kts}sched_autogroup_enabled" "1"
write "${kts}random/read_wakeup_threshold" "64"
write "${kts}random/write_wakeup_threshold" "512"
write "${kts}sched_tunable_scaling" "0"
write "${kts}sched_latency_ns" "$SCHED_PERIOD"
write "${kts}sched_min_granularity_ns" "$((SCHED_PERIOD / SCHED_TASKS))"
write "${kts}sched_wakeup_granularity_ns" "$((SCHED_PERIOD / 2))"
write "${kts}sched_migration_cost_ns" "5000000"
write "${kts}sched_min_task_util_for_colocation" "0"
write "${kts}sched_nr_migrate" "8"
write "${kts}sched_schedstats" "0"
write "${kts}printk_devkmsg" "off"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          SETTING MIN AND MAX CPU FREQUENCY...                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Set max clocks in gaming / performance profile.
for minclk in /sys/devices/system/cpu/cpufreq/policy*/
do
if [[ -e "${minclk}scaling_min_freq" ]]
then
write "${minclk}scaling_min_freq" "20000000"
write "${minclk}scaling_max_freq" "20000000"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING EFFICIENT CPUSET...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Efficient CPU Set.
for cs in /dev/cpuset/
do
if [[ -d "/dev/cpuset" ]]
then
write "${cs}game/cpus" "0-7"
write "${cs}gamelite/cpus" "0-3,4-7"
write "${cs}camera-daemon/cpus" "0-7"
write "${cs}vr/cpus" "0-7"
write "${cs}top-app/cpus" "0-7"
write "${cs}audio-app/cpus" "1-2"
write "${cs}background/cpus" "0-3"
write "${cs}foreground/cpus" "0-7"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING VM TWEAKS...                                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# VM settings to improve overall user experience and performance.
for vm in /proc/sys/vm/
do
if [[ -d "/proc/sys/vm" ]]
then
write "${vm}drop_caches" "3"
write "${vm}dirty_background_ratio" "10"
write "${vm}dirty_ratio" "30"
write "${vm}dirty_expire_centisecs" "3000"
write "${vm}dirty_writeback_centisecs" "3000"
write "${vm}page-cluster" "0"
write "${vm}stat_interval" "10"
write "${vm}swappiness" "100"
write "${vm}swap_ratio_enable" "1"
write "${vm}swap_ratio" "100"
write "${vm}vfs_cache_pressure" "200"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING MSM THERMAL SETTINGS...                                                                       "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# MSM thermal
if [[ -d "/sys/module/msm_thermal" ]]
then
write /sys/module/msm_thermal/vdd_restriction/enabled "0"
write /sys/module/msm_thermal/core_control/enabled "0"
write /sys/module/msm_thermal/parameters/enabled "N"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING POWER EFFICIENT WORKQUEUE...                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Workqueue enable power_efficient.
for wqpw in /sys/module/workqueue/parameters/
do
if [[ -d "/sys/module/workqueue" ]]
then 
write "${wqpw}power_efficient" "Y"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          FIXING DOUBLE TAP TO WAKEUP...                                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Fix DT2W
for dt in /sys/touchpanel/
do
if [[ -d "/sys/touchpanel" ]]
then
write "${dt}double_tap" "1"
fi
done

if [[ -f "/proc/tp_gesture" ]]
then
write "/proc/tp_gesture" "1"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING MSM TOUCH BOOST...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable touch boost on gaming and performance profile.
if [[ -e /sys/module/msm_performance/parameters/touchboost ]]
then
write "/sys/module/msm_performance/parameters/touchboost" "1"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING INTERNET TWEAKS...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Internet Tweaks
for tcp in /proc/sys/net/ipv4/
do
if [[ -d "/proc/sys/net" ]]
then
write "${tcp}ip_no_pmtu_disc" "0"
write "${tcp}tcp_ecn" "1"
write "${tcp}tcp_timestamps" "0"
write "${tcp}route.flush" "1"
write "${tcp}tcp_rfc1337" "1"
write "${tcp}tcp_tw_reuse" "1"
write "${tcp}tcp_sack" "1"
write "${tcp}tcp_fack" "1"
write "${tcp}tcp_fastopen" "3"
write "${tcp}tcp_tw_recycle" "1"
write "${tcp}tcp_syncookies" "0"
write "${tcp}tcp_window_scaling" "1"
write "${tcp}tcp_keepalive_probes" "10"
write "${tcp}tcp_keepalive_intvl" "30"
write "${tcp}tcp_fin_timeout" "30"
write "${tcp}tcp_low_latency" "1"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          CALIBRATING TOUCH...                                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Touch calibration
panel=$(cat /sys/class/graphics/fb0/modes)
  if [ "${panel:5:1}" == "x" ]; then
    panel=${panel:2:3}
  else
    panel=${panel:2:4}
  fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING LPM...                                                                                       "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
  
# Disable LPM in gaming profile / performance profile
for lpm in /sys/module/lpm_levels/parameters/
do
if [[ -d /sys/module/lpm_levels ]]
then
write "${lpm}sleep_disabled" "Y"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING FORCE FAST CHARGING...                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable Fast Charging Rate
for ffc in /sys/kernel/fast_charge/
do
if [[ -e "/sys/kernel/fast_charge/force_fast_charge" ]]
then
write "${ffc}force_fast_charge" "1"
fi
done
  
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          KILLING GMS PROCESSES...                                                                               "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# GMS blocker 1.2 by @pedroginkgo
busybox killall -9 com.google.android.gms
busybox killall -9 com.google.android.gms.persistent
busybox killall -9 com.google.process.gapps
busybox killall -9 com.google.android.gsf
busybox killall -9 com.google.android.gsf.persistent

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                     PERFORMANCE PROFILE APPLIED WITH SUCCESS.                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
vibrate_cmode
};;
    # Battery Profile
        "2") {
        	kmsg ""
kmsg "---------------------------------------------------------- Info --------------------------------------------------------------------------------------------"
kmsg "                                            üïõ Date of execution: $(date)                                                                                   "
kmsg "                                            üîß Device kernel: `uname -a`                                                                                    "
kmsg "                                            üõ†Ô∏è SOC: $(getprop ro.board.platform)                                                                            "
kmsg "                                            ‚öôÔ∏è SDK: $(getprop ro.build.version.sdk)                                                                         "
kmsg "                                            üÖ∞Ô∏èndroid Version: $(getprop ro.build.version.release)                                                           "
kmsg "                                            üì± Device: $(getprop ro.product.odm.model)                                                                      "
kmsg "                                            üëë KTS Version: 1.8.1                                                                                           "
kmsg "------------------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg ""

	kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
	kmsg "                                        ENABLING BATTERY PROFILE...                                                                              "
	kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
	
	# Duration in nanoseconds of one scheduling period
SCHED_PERIOD="$((1 * 1000 * 1000))"

# How many tasks should we have at a maximum in one scheduling period
SCHED_TASKS="8"

# Maximum unsigned integer size in C
UINT_MAX="4294967295"

# Variable to battery %
percentage=$(cat /sys/class/power_supply/battery/capacity)

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING THERMAL-ENGINE AND PERFD...                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
    	
# Enable throttling and perfd.
start thermal-engine
start perfd
    
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING I/O SCHEDULER...                                                                              "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# I/O Scheduler Tweaks.
for queue in /sys/block/*/queue/
do
 avail_scheds="$(cat "${queue}scheduler")"
 for sched in cfq noop zen anxiety fiops sio maple tripndroid kyber bfq mq-deadline none
 do
  if [[ "$avail_scheds" == *"$sched"* ]]
  then
   write "${queue}scheduler" "$sched"
   break
  fi
 done
 write "${queue}add_random" 0
 write "${queue}iostats" 0
 write "${queue}read_ahead_kb" 128
 write "${queue}nr_requests" 64
done

# Reserve 90% IO bandwith for foreground tasks
if [[ -d "/dev/blkio" ]]
then
write "/dev/blkio/blkio.weight" "1000"
write "/dev/blkio/blkio.leaf_weight" "1000"
write "/dev/blkio/background/blkio.weight" "100"
write "/dev/blkio/background/blkio.leaf_weight" "100"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                         TWEAKING CPU...                                                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# CPU Tweaks
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/
do
avail_govs=`cat "${cpu}scaling_available_governors"`
if [[ "$avail_govs" == *"schedutil"* ]]
then
write "${cpu}scaling_governor" schedutil
write "${cpu}schedutil/up_rate_limit_us" "$((SCHED_PERIOD / 1000))"
write "${cpu}schedutil/down_rate_limit_us" "$((4 * SCHED_PERIOD / 1000))"
write "${cpu}schedutil/iowait_boost_enable" "0"
write "${cpu}schedutil/rate_limit_us" "$((SCHED_PERIOD / 1000))"
write "${cpu}schedutil/hispeed_load" "99"
write "${cpu}schedutil/hispeed_freq" "$UINT_MAX"
elif [[ "$avail_govs" == *"interactive"* ]]
then
write "${cpu}scaling_governor" interactive
write "${cpu}interactive/timer_rate" "$((SCHED_PERIOD / 1000))"
write "${cpu}interactive/timer_slack" "-1"
write "${cpu}interactive/boost" "0"
write "${cpu}interactive/boostpulse" "0"
write "${cpu}interactive/fast_ramp_down" "0"
write "${cpu}interactive/sampling_rate" "10000"
write "${cpu}interactive/sampling_rate_min" "10000"
write "${cpu}interactive/min_sample_time" "$((SCHED_PERIOD / 1000))"
write "${cpu}interactive/go_hispeed_load" "99"
write "${cpu}interactive/hispeed_freq" "$UINT_MAX"
fi
done
	
if [[ $percentage -le "20" ]]
then
write "/sys/devices/system/cpu/cpu1/online" "0"
write "/sys/devices/system/cpu/cpu2/online" "0"
write "/sys/devices/system/cpu/cpu5/online" "0"
write "/sys/devices/system/cpu/cpu6/online" "0"

else [[ $percentage -ge "20" ]]
write "/sys/devices/system/cpu/cpu1/online" "1"
write "/sys/devices/system/cpu/cpu2/online" "1"
write "/sys/devices/system/cpu/cpu5/online" "1"
write "/sys/devices/system/cpu/cpu6/online" "1"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING GPU...                                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
	
# GPU Tweaks
for gpu in /sys/class/kgsl/kgsl-3d0/
do
if [[ -d "/sys/class/kgsl/kgsl-3d0" ]]
then
write "${gpu}throttling" "1"
write "${gpu}thermal_pwrlevel" "3"
write "${gpu}devfreq/adrenoboost" "0"
write "${gpu}force_no_nap" "0"
write "${gpu}bus_split" "1"
write "${gpu}devfreq/min_freq" "100000000"
write "${gpu}default_pwrlevel" `cat /sys/class/kgsl/kgsl-3d0/min_pwrlevel`
write "${gpu}force_bus_on" "0"
write "${gpu}force_clk_on" "0"
write "${gpu}force_rail_on" "0"
fi
done

# Set clock to 465 mhz in battery profile if battery < than 20% and 600 mhz if > 20%
for gpu in /sys/class/kgsl/kgsl-3d0/
do
if [[ $percentage -le "50" && -e "${gpu}devfreq/max_freq" ]]
then
write "${gpu}devfreq/max_freq" "465000000"

else [[ $percentage -ge "50" && -e "${gpu}devfreq/max_freq" ]]
write "${gpu}devfreq/max_freq" "600000000"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING ADRENO IDLER...                                                                               "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable adreno idler
if [[ -d "/sys/module/adreno_idler" ]]
then
write "/sys/module/adreno_idler/parameters/adreno_idler_active" "Y"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING LMK...                                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Low Memory Killer tweaks
for lmk in /sys/module/lowmemorykiller/parameters/
do
if [[ -d "/sys/module/lowmemorykiller" ]]
then
write "${lmk}enable_lmk" "1"
write "${lmk}enable_adaptive_lmk" "1"
write "${lmk}minfree" "21816,29088,36360,43632,50904,65448"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING DEBUGGERS...                                                                                 "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Disable debuggers.
for bl in /sys/module/bluetooth/parameters/
do
if [[ -d /sys/module/bluetooth ]]
then
write "${bl}disable_ertm" "Y"
write "${bl}disable_esco" "Y"
fi
done

write "/sys/module/earlysuspend/parameters/debug_mask" "0"
write "/sys/module/alarm/parameters/debug_mask" "0"
write "/sys/module/alarm_dev/parameters/debug_mask" "0"
write "/sys/module/binder/parameters/debug_mask" "0"
write "/sys/devices/system/edac/cpu/log_ce" "0"
write "/sys/devices/system/edac/cpu/log_ue" "0"
write "/sys/module/binder/parameters/debug_mask" "0"
write "/sys/module/debug/parameters/enable_event_log" "0"
write "/sys/module/dwc3/parameters/ep_addr_rxdbg_mask" "0"
write "/sys/module/dwc3/parameters/ep_addr_txdbg_mask" "0"
write "/sys/module/edac_core/parameters/edac_mc_log_ce" "0"
write "/sys/module/edac_core/parameters/edac_mc_log_ue" "0"
write "/sys/module/glink/parameters/debug_mask" "0"
write "/sys/module/hid_apple/parameters/fnmode" "0"
write "/sys/module/hid_magicmouse/parameters/emulate_3button" "N"
write "/sys/module/hid_magicmouse/parameters/emulate_scroll_wheel" "N"
write "/sys/module/ip6_tunnel/parameters/log_ecn_error" "N"
write "/sys/module/lowmemorykiller/parameters/debug_level" "0"
write "/sys/module/mdss_fb/parameters/backlight_dimmer" "N"
write "/sys/module/msm_show_resume_irq/parameters/debug_mask" "0"
write "/sys/module/msm_smd/parameters/debug_mask" "0"
write "/sys/module/msm_smem/parameters/debug_mask" "0"
write "/sys/module/otg_wakelock/parameters/enabled" "N" 
write "/sys/module/service_locator/parameters/enable" "0"
write "/sys/module/sit/parameters/log_ecn_error" "N"
write "/sys/module/smem_log/parameters/log_enable" "0"
write "/sys/module/smp2p/parameters/debug_mask" "0"
write "/sys/module/touch_core_base/parameters/debug_mask" "0"
write "/sys/module/usb_bam/parameters/enable_event_log" "0"
write "/sys/module/printk/parameters/console_suspend" "Y"
write "/proc/sys/debug/exception-trace" "0"
write "/proc/sys/kernel/printk" "0 0 0 0"
write "/proc/sys/kernel/compat-log" "0"

if [ -e /sys/module/logger/parameters/log_mode ]
then
write "/sys/module/logger/parameters/log_mode" "2"
fi

if [ -e /sys/module/printk/parameters/console_suspend ] 
then
write "/sys/module/printk/parameters/console_suspend" "Y"
fi

for i in $(find /sys/ -name debug_mask)
do
write "$i" "0"
done

for i in $(find /sys/ -name debug_level)
do
write "$i" "0"
done

for i in $(find /sys/ -name edac_mc_log_ce)
do
write "$i" "0"
done

for i in $(find /sys/ -name edac_mc_log_ue)
do
write "$i" "0"
done

for i in $(find /sys/ -name enable_event_log) 
do
write "$i" "0"
done

for i in $(find /sys/ -name log_ecn_error)
do
write "$i" "N"
done

for i in $(find /sys/ -name snapshot_crashdumper)
do
write "$i" "0"
done

# =========
# FIX DEEPSLEEP
# =========
for i in $(ls /sys/class/scsi_disk/)
do
lock_val 'temporary none' '/sys/class/scsi_disk/$i/cache_type'
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING SCHEDTUNE TWEAKS...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Schedtune tweaks
for st in /dev/stune
do
if [[ -d "/dev/stune" ]]
then
write "${st}/background/schedtune.boost" "0"
write "${st}/background/schedtune.prefer_idle" "0"

write "${st}/foreground/schedtune.boost" "0"
write "${st}/foreground/schedtune.prefer_idle" "0"

write "${st}/rt/schedtune.boost" "0"
write "${st}/rt/schedtune.prefer_idle" "0"

write "${st}/top-app/schedtune.boost" "1"
write "${st}/top-app/schedtune.prefer_idle" "0"

write "${st}/schedtune.boost" "0"
write "${st}/schedtune.prefer_idle" "0"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING FS TWEAKS...                                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# FS Tweaks.
for fs in /proc/sys/fs/
do
if [[ -d "/proc/sys/fs" ]]
then
write "${fs}dir-notify-enable" "0"
write "${fs}lease-break-time" "25"
fi
done
    
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING DYNAMIC FSYNC...                                                                              "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable dynamic_fsync.
if [[ -e /sys/kernel/dyn_fsync/dyn_fsync_active ]]
then
chmod 666 /sys/kernel/dyn_fsync/dyn_fsync_active
chown root /sys/kernel/dyn_fsync/dyn_fsync_active
write "/sys/kernel/dyn_fsync/dyn_fsync_active" "1"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING SCHEDULER TWEAKS...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Scheduler features.
for sched in /sys/kernel/debug/
do
if [[ -e "/sys/kernel/debug/sched_features" ]]
then
write "${sched}sched_features" "NEXT_BUDDY"
write "${sched}sched_features" "TTWU_QUEUE"
write "${sched}sched_features" "NO_WAKEUP_PREEMPTION"
fi
done
	
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING ONEPLUS CHAIN...                                                                             "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# OP Tweaks
for opc in /sys/module/opchain/parameters/
do
if [[ -d "/sys/module/opchain" ]]
then
write "${opc}chain_on" "0"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING KERNEL SETTINGS...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Tweak some kernel settings to improve overall performance.
for kts in /proc/sys/kernel/
do
if [[ -d "/proc/sys/kernel" ]] 
then
write "${kts}sched_child_runs_first" "1"
write "${kts}perf_cpu_time_max_percent" "5"
write "${kts}sched_autogroup_enabled" "1"
write "${kts}random/read_wakeup_threshold" "64"
write "${kts}random/write_wakeup_threshold" "128"
write "${kts}sched_tunable_scaling" "0"
write "${kts}sched_latency_ns" "$SCHED_PERIOD"
write "${kts}sched_min_granularity_ns" "$((SCHED_PERIOD / SCHED_TASKS))"
write "${kts}sched_wakeup_granularity_ns" "$((SCHED_PERIOD / 2))"
write "${kts}sched_migration_cost_ns" "5000000"
write "${kts}sched_min_task_util_for_colocation" "0"
write "${kts}sched_nr_migrate" "8"
write "${kts}sched_schedstats" "0"
write "${kts}printk_devkmsg" "off"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          SETTING MIN AND MAX CPU FREQUENCY...                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Set min and max clocks.
for minclk in /sys/devices/system/cpu/cpufreq/policy*/
do
if [[ $percentage -le "20" && -e "${minclk}scaling_min_freq" ]]
then
write "${minclk}scaling_min_freq" "300000"
write "${minclk}scaling_max_freq" "20000000"

else [[ $percentage -ge "20" && -e "${minclk}scaling_min_freq" ]]
write "${minclk}scaling_min_freq" "300000"
write "${minclk}scaling_max_freq" "1300000"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING EFFICIENT CPUSET...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Efficient CPU Set.
for cs in /dev/cpuset/
do
if [[ -d "/dev/cpuset" ]]
then
write "${cs}game/cpus" "0-7"
write "${cs}gamelite/cpus" "0-3,4-7"
write "${cs}camera-daemon/cpus" "0-7"
write "${cs}vr/cpus" "0-7"
write "${cs}top-app/cpus" "0-7"
write "${cs}audio-app/cpus" "1-2"
write "${cs}background/cpus" "0-3"
write "${cs}foreground/cpus" "0-7"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING VM TWEAKS...                                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# VM settings to improve overall user experience and performance.
for vm in /proc/sys/vm/
do
if [[ -d "/proc/sys/vm" ]]
then
write "${vm}drop_caches" "3"
write "${vm}dirty_background_ratio" "10"
write "${vm}dirty_ratio" "30"
write "${vm}dirty_expire_centisecs" "3000"
write "${vm}dirty_writeback_centisecs" "3000"
write "${vm}page-cluster" "0"
write "${vm}stat_interval" "10"
write "${vm}swap_ratio_enable" "1"
write "${vm}swap_ratio" "100"
write "${vm}swappiness" "100"
write "${vm}vfs_cache_pressure" "200"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING MSM THERMAL SETTINGS...                                                                       "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# MSM thermal
if [[ -d "/sys/module/msm_thermal" ]]
then
write /sys/module/msm_thermal/vdd_restriction/enabled "1"
write /sys/module/msm_thermal/core_control/enabled "1"
write /sys/module/msm_thermal/parameters/enabled "Y"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING POWER EFFICIENT WORKQUEUE...                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Workqueue enable power_efficient.
for wqpw in /sys/module/workqueue/parameters/
do
if [[ -e "/sys/module/workqueue/parameters/power_efficient" ]]
then 
write "${wqpw}power_efficient" "Y"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          FIXING DOUBLE TAP TO WAKEUP...                                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Fix DT2W
for dt in /sys/touchpanel/
do
if [[ -d "/sys/touchpanel" ]]
then
write "${dt}double_tap" "1"
fi
done

if [[ -e "/proc/tp_gesture" ]]
then
write "/proc/tp_gesture" "1"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING MSM TOUCH BOOST...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Disable touch boost on battery and balance profile.
if [[ -e /sys/module/msm_performance/parameters/touchboost ]]
then
write "/sys/module/msm_performance/parameters/touchboost" "0"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING INTERNET TWEAKS...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Internet Tweaks
for tcp in /proc/sys/net/ipv4/
do
if [[ -d "/proc/sys/net" ]]
then
write "${tcp}ip_no_pmtu_disc" "0"
write "${tcp}tcp_ecn" "1"
write "${tcp}tcp_timestamps" "0"
write "${tcp}route.flush" "1"
write "${tcp}tcp_rfc1337" "1"
write "${tcp}tcp_tw_reuse" "1"
write "${tcp}tcp_sack" "1"
write "${tcp}tcp_fack" "1"
write "${tcp}tcp_fastopen" "3"
write "${tcp}tcp_tw_recycle" "1"
write "${tcp}tcp_syncookies" "0"
write "${tcp}tcp_window_scaling" "1"
write "${tcp}tcp_keepalive_probes" "10"
write "${tcp}tcp_keepalive_intvl" "30"
write "${tcp}tcp_fin_timeout" "30"
write "${tcp}tcp_low_latency" "1"
fi
done

# Tweak and decrease tx_queue_len default stock value(s) for less amount of generated bufferbloat and for gaining slightly faster network speed and performance;
for i in $(find /sys/class/net -type l)
do
write "$i/tx_queue_len" "128"
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          CALIBRATING TOUCH...                                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Touch calibration
panel=$(cat /sys/class/graphics/fb0/modes)
if [[ "${panel:5:1}" == "x" ]]
then
panel=${panel:2:3}
else
panel=${panel:2:4}
fi
  
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING BATTERY SAVER...                                                                              "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable battery saver
for bs in /sys/module/battery_saver/parameters/
do
if [[ -d /sys/module/battery_saver ]]
then
write "${bs}enabled" "Y"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING LPM...                                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable LPM in battery / balanced profile
for lpm in /sys/module/lpm_levels/parameters/
do
if [[ -d /sys/module/lpm_levels ]]
then
write "${lpm}sleep_disabled" "N"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING FORCE FAST CHARGING...                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable Fast Charging Rate
for ffc in /sys/kernel/fast_charge/
do
if [[ -f "/sys/kernel/fast_charge/force_fast_charge" ]]
then
write "${ffc}force_fast_charge" "1"
fi
done
  
# GMS blocker 1.2 by @pedroginkgo
busybox killall -9 com.google.android.gms
busybox killall -9 com.google.android.gms.persistent
busybox killall -9 com.google.process.gapps
busybox killall -9 com.google.android.gsf
busybox killall -9 com.google.android.gsf.persistent

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                     BATTERY PROFILE APPLIED WITH SUCCESS.                                                                       "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
vibrate_cmode
};;
    # Gaming Profile
        "3") {
        	kmsg ""
kmsg "---------------------------------------------------------- Info --------------------------------------------------------------------------------------------"
kmsg "                                            üïõ Date of execution: $(date)                                                                                   "
kmsg "                                            üîß Device kernel: `uname -a`                                                                                    "
kmsg "                                            üõ†Ô∏è SOC: $(getprop ro.board.platform)                                                                            "
kmsg "                                            ‚öôÔ∏è SDK: $(getprop ro.build.version.sdk)                                                                         "
kmsg "                                            üÖ∞Ô∏èndroid Version: $(getprop ro.build.version.release)                                                           "
kmsg "                                            üì± Device: $(getprop ro.product.odm.model)                                                                      "
kmsg "                                            üëë KTS Version: 1.8.1                                                                                           "
kmsg "------------------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg ""

	kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
	kmsg "                                           ENABLING GAMING PROFILE...                                                                            "
	kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
       
        	# Duration in nanoseconds of one scheduling period
SCHED_PERIOD="$((1 * 1000 * 1000))"

# How many tasks should we have at a maximum in one scheduling period
SCHED_TASKS="8"

# Maximum unsigned integer size in C
UINT_MAX="4294967295"

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING THERMAL-ENGINE AND PERFD...                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Disable throttling and perfd.
stop thermal-engine
stop perfd

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING CPU INPUT BOOST...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Caf CPU Boost
for caf in /sys/module/cpu_boost/parameters/
do
if [[ -d "/sys/module/cpu_boost/parameters" ]]
then
write "${caf}input_boost_freq" "0:$UINT_MAX 1:$UINT_MAX 2:$UINT_MAX 3:$UINT_MAX 4:$UINT_MAX 5:$UINT_MAX 6:$UINT_MAX 7:$UINT_MAX"
write "${caf}input_boost_ms" "64"
fi
done

# CPU Boost
for cib in /sys/module/cpu_input_boost/parameters/
do
if [[ -d "/sys/module/cpu_input_boost" ]]
then
write "${cib}input_boost_duration" "64"
write "${cib}input_boost_freq_hp" "$UINT_MAX"
write "${cib}input_boost_freq_lp" "$UINT_MAX"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING I/O SCHEDULER...                                                                              "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# I/O Scheduler Tweaks.
for queue in /sys/block/*/queue/
do
 avail_scheds="$(cat "${queue}scheduler")"
 for sched in zen anxiety cfq noop kyber bfq mq-deadline none
 do
  if [[ "$avail_scheds" == *"$sched"* ]]
  then
   write "${queue}scheduler" "$sched"
   break
  fi
 done
 write "${queue}add_random" 0
 write "${queue}iostats" 0
 write "${queue}read_ahead_kb" 128
 write "${queue}nr_requests" 64
done

# Reserve 90% IO bandwith for foreground tasks
if [[ -d "/dev/blkio" ]]
then
write "/dev/blkio/blkio.weight" "1000"
write "/dev/blkio/blkio.leaf_weight" "1000"
write "/dev/blkio/background/blkio.weight" "100"
write "/dev/blkio/background/blkio.leaf_weight" "100"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                         TWEAKING CPU...                                                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# CPU Tweaks
for cpu in /sys/devices/system/cpu/cpu*/cpufreq/
do
avail_govs=`cat "${cpu}scaling_available_governors"`
if [[ "$avail_govs" == *"schedutil"* ]]
then
write "${cpu}scaling_governor" schedutil
write "${cpu}schedutil/up_rate_limit_us" "$((SCHED_PERIOD / 1000))"
write "${cpu}schedutil/down_rate_limit_us" "$((4 * SCHED_PERIOD / 1000))"
write "${cpu}schedutil/iowait_boost_enable" "1"
write "${cpu}schedutil/rate_limit_us" "$((SCHED_PERIOD / 1000))"
write "${cpu}schedutil/hispeed_load" "80"
write "${cpu}schedutil/hispeed_freq" "$UINT_MAX"
elif [[ "$avail_govs" == *"interactive"* ]]
then
write "${cpu}scaling_governor" interactive
write "${cpu}interactive/timer_rate" "$((SCHED_PERIOD / 1000))"
write "${cpu}interactive/timer_slack" "-1"
write "${cpu}interactive/boost" "1"
write "${cpu}interactive/boostpulse" "1"
write "${cpu}interactive/boostpulse_duration" "640000"
write "${cpu}interactive/fast_ramp_down" "1"
write "${cpu}interactive/sampling_rate" "5000"
write "${cpu}interactive/sampling_rate_min" "5000"
write "${cpu}interactive/min_sample_time" "$((SCHED_PERIOD / 1000))"
write "${cpu}interactive/go_hispeed_load" "80"
write "${cpu}interactive/hispeed_freq" "$UINT_MAX"
fi
done
	
write "/sys/devices/system/cpu/cpu1/online" "1"
write "/sys/devices/system/cpu/cpu2/online" "1"
write "/sys/devices/system/cpu/cpu5/online" "1"
write "/sys/devices/system/cpu/cpu6/online" "1"

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING GPU...                                                                                        "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
	
# GPU Tweaks.
for gpu in /sys/class/kgsl/kgsl-3d0/
do
if [[ -d "/sys/class/kgsl/kgsl-3d0" ]]
then
write "${gpu}throttling" "0"
write "${gpu}thermal_pwrlevel" "0"
write "${gpu}devfreq/adrenoboost" "3"
write "${gpu}force_no_nap" "1"
write "${gpu}bus_split" "0"
write "${gpu}devfreq/min_freq" "$UINT_MAX"
write "${gpu}devfreq/max_freq" "$UINT_MAX"
write "${gpu}default_pwrlevel" `cat /sys/class/kgsl/kgsl-3d0/max_pwrlevel`
write "${gpu}force_bus_on" "1"
write "${gpu}force_clk_on" "1"
write "${gpu}force_rail_on" "1"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING ADRENO IDLER...                                                                               "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable adreno idler
if [[ -d "/sys/module/adreno_idler" ]]
then
write "/sys/module/adreno_idler/parameters/adreno_idler_active" "Y"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                             TWEAKING LMK...                                                                                     "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Low Memory Killer Tweaks.
for lmk in /sys/module/lowmemorykiller/parameters/
do
if [[ -d "/sys/module/lowmemorykiller" ]]
then
write "${lmk}enable_lmk" "1"
write "${lmk}enable_adaptive_lmk" "1"
write "${lmk}minfree" "21816,29088,36360,43632,50904,65448"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING DEBUGGERS...                                                                                 "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Disable debuggers.
for bl in /sys/module/bluetooth/parameters/
do
if [[ -d /sys/module/bluetooth ]]
then
write "${bl}disable_ertm" "Y"
write "${bl}disable_esco" "Y"
fi
done

write "/sys/module/earlysuspend/parameters/debug_mask" "0"
write "/sys/module/alarm/parameters/debug_mask" "0"
write "/sys/module/alarm_dev/parameters/debug_mask" "0"
write "/sys/module/binder/parameters/debug_mask" "0"
write "/sys/devices/system/edac/cpu/log_ce" "0"
write "/sys/devices/system/edac/cpu/log_ue" "0"
write "/sys/module/binder/parameters/debug_mask" "0"
write "/sys/module/debug/parameters/enable_event_log" "0"
write "/sys/module/dwc3/parameters/ep_addr_rxdbg_mask" "0"
write "/sys/module/dwc3/parameters/ep_addr_txdbg_mask" "0"
write "/sys/module/edac_core/parameters/edac_mc_log_ce" "0"
write "/sys/module/edac_core/parameters/edac_mc_log_ue" "0"
write "/sys/module/glink/parameters/debug_mask" "0"
write "/sys/module/hid_apple/parameters/fnmode" "0"
write "/sys/module/hid_magicmouse/parameters/emulate_3button" "N"
write "/sys/module/hid_magicmouse/parameters/emulate_scroll_wheel" "N"
write "/sys/module/ip6_tunnel/parameters/log_ecn_error" "N"
write "/sys/module/lowmemorykiller/parameters/debug_level" "0"
write "/sys/module/mdss_fb/parameters/backlight_dimmer" "N"
write "/sys/module/msm_show_resume_irq/parameters/debug_mask" "0"
write "/sys/module/msm_smd/parameters/debug_mask" "0"
write "/sys/module/msm_smem/parameters/debug_mask" "0"
write "/sys/module/otg_wakelock/parameters/enabled" "N" 
write "/sys/module/service_locator/parameters/enable" "0"
write "/sys/module/sit/parameters/log_ecn_error" "N"
write "/sys/module/smem_log/parameters/log_enable" "0"
write "/sys/module/smp2p/parameters/debug_mask" "0"
write "/sys/module/touch_core_base/parameters/debug_mask" "0"
write "/sys/module/usb_bam/parameters/enable_event_log" "0"
write "/sys/module/printk/parameters/console_suspend" "Y"
write "/proc/sys/debug/exception-trace" "0"
write "/proc/sys/kernel/printk" "0 0 0 0"
write "/proc/sys/kernel/compat-log" "0"

if [ -e /sys/module/logger/parameters/log_mode ]
then
write "/sys/module/logger/parameters/log_mode" "2"
fi

if [ -e /sys/module/printk/parameters/console_suspend ] 
then
write "/sys/module/printk/parameters/console_suspend" "Y"
fi

for i in $(find /sys/ -name debug_mask)
do
write "$i" "0"
done

for i in $(find /sys/ -name debug_level)
do
write "$i" "0"
done

for i in $(find /sys/ -name edac_mc_log_ce)
do
write "$i" "0"
done

for i in $(find /sys/ -name edac_mc_log_ue)
do
write "$i" "0"
done

for i in $(find /sys/ -name enable_event_log) 
do
write "$i" "0"
done

for i in $(find /sys/ -name log_ecn_error)
do
write "$i" "N"
done

for i in $(find /sys/ -name snapshot_crashdumper)
do
write "$i" "0"
done

# =========
# FIX DEEPSLEEP
# =========
for i in $(ls /sys/class/scsi_disk/)
do
lock_val 'temporary none' '/sys/class/scsi_disk/$i/cache_type'
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                            APPLYING SCHEDTUNE TWEAKS...                                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Schedtune Tweaks
for st in /dev/stune
do
if [[ -d "/dev/stune" ]]
then
write "${st}/background/schedtune.boost" "5"
write "${st}/background/schedtune.prefer_idle" "0"

write "${st}/foreground/schedtune.boost" "40"
write "${st}/foreground/schedtune.prefer_idle" "1"

write "${st}/rt/schedtune.boost" "0"
write "${st}/rt/schedtune.prefer_idle" "0"

write "${st}/top-app/schedtune.boost" "40"
write "${st}/top-app/schedtune.prefer_idle" "1"

write "${st}/schedtune.boost" "0"
write "${st}/schedtune.prefer_idle" "0"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                            APPLYING FS TWEAKS...                                                                                "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# FS Tweaks.
for fs in /proc/sys/fs/
do
if [[ -d "/proc/sys/fs" ]]
then
write "${fs}dir-notify-enable" "0"
write "${fs}lease-break-time" "25"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING DYNAMIC FSYNC...                                                                              "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable dynamic_fsync.
if [[ -e /sys/kernel/dyn_fsync/dyn_fsync_active ]]
then
chmod 666 /sys/kernel/dyn_fsync/dyn_fsync_active
chown root /sys/kernel/dyn_fsync/dyn_fsync_active
write "/sys/kernel/dyn_fsync/dyn_fsync_active" "1"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING SCHEDULER TWEAKS...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Scheduler features.
for sched in /sys/kernel/debug/
do
if [[ -f "/sys/kernel/debug/sched_features" ]]
then
write "${sched}sched_features" "NEXT_BUDDY"
write "${sched}sched_features" "TTWU_QUEUE"
write "${sched}sched_features" "NO_GENTLE_FAIR_SLEEPERS"
fi
done
	
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING ONEPLUS CHAIN...                                                                             "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# OP Tweaks
for opc in /sys/module/opchain/parameters/
do
if [[ -d "/sys/module/opchain" ]]
then
write "${opc}chain_on" "0"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          TWEAKING KERNEL SETTINGS...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Tweak some kernel settings to improve overall performance.
for kts in /proc/sys/kernel/
do
if [[ -d "/proc/sys/kernel" ]] 
then
write "${kts}sched_child_runs_first" "1"
write "${kts}perf_cpu_time_max_percent" "5"
write "${kts}sched_autogroup_enabled" "1"
write "${kts}random/read_wakeup_threshold" "64"
write "${kts}random/write_wakeup_threshold" "512"
write "${kts}sched_tunable_scaling" "0"
write "${kts}sched_latency_ns" "$SCHED_PERIOD"
write "${kts}sched_min_granularity_ns" "$((SCHED_PERIOD / SCHED_TASKS))"
write "${kts}sched_wakeup_granularity_ns" "$((SCHED_PERIOD / 2))"
write "${kts}sched_migration_cost_ns" "5000000"
write "${kts}sched_min_task_util_for_colocation" "0"
write "${kts}sched_nr_migrate" "8"
write "${kts}sched_schedstats" "0"
write "${kts}printk_devkmsg" "off"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          SETTING MIN AND MAX CPU FREQUENCY...                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Set max clocks in gaming / performance profile.
for minclk in /sys/devices/system/cpu/cpufreq/policy*/
do
if [[ -e "${minclk}scaling_min_freq" ]]
then
write "${minclk}scaling_min_freq" "20000000"
write "${minclk}scaling_max_freq" "20000000"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING EFFICIENT CPUSET...                                                                           "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Efficient CPU Set.
for cs in /dev/cpuset/
do
if [[ -d "/dev/cpuset" ]]
then
write "${cs}game/cpus" "0-7"
write "${cs}gamelite/cpus" "0-3,4-7"
write "${cs}camera-daemon/cpus" "0-7"
write "${cs}vr/cpus" "0-7"
write "${cs}top-app/cpus" "0-7"
write "${cs}audio-app/cpus" "1-2"
write "${cs}background/cpus" "0-3"
write "${cs}foreground/cpus" "0-7"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING VM TWEAKS...                                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# VM settings to improve overall user experience and performance.
for vm in /proc/sys/vm/
do
if [[ -d "/proc/sys/vm" ]]
then
write "${vm}drop_caches" "3"
write "${vm}dirty_background_ratio" "10"
write "${vm}dirty_ratio" "30"
write "${vm}dirty_expire_centisecs" "3000"
write "${vm}dirty_writeback_centisecs" "3000"
write "${vm}page-cluster" "0"
write "${vm}stat_interval" "10"
write "${vm}swappiness" "100"
write "${vm}swap_ratio_enable" "1"
write "${vm}swap_ratio" "100"
write "${vm}vfs_cache_pressure" "200"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING MSM THERMAL SETTINGS...                                                                       "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# MSM thermal
if [[ -d "/sys/module/msm_thermal" ]]
then
write /sys/module/msm_thermal/vdd_restriction/enabled "0"
write /sys/module/msm_thermal/core_control/enabled "0"
write /sys/module/msm_thermal/parameters/enabled "N"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING POWER EFFICIENT WORKQUEUE...                                                                  "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Workqueue enable power_efficient.
for wqpw in /sys/module/workqueue/parameters/
do
if [[ -d "/sys/module/workqueue" ]]
then 
write "${wqpw}power_efficient" "Y"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          FIXING DOUBLE TAP TO WAKEUP...                                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Fix DT2W
for dt in /sys/touchpanel/
do
if [[ -d "/sys/touchpanel" ]]
then
write "${dt}double_tap" "1"
fi
done

if [[ -f "/proc/tp_gesture" ]]
then
write "/proc/tp_gesture" "1"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          ENABLING MSM TOUCH BOOST...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable touch boost on gaming and performance profile.
if [[ -e /sys/module/msm_performance/parameters/touchboost ]]
then
write "/sys/module/msm_performance/parameters/touchboost" "1"
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          APPLYING INTERNET TWEAKS...                                                                            "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Internet Tweaks
for tcp in /proc/sys/net/ipv4/
do
if [[ -d "/proc/sys/net" ]]
then
write "${tcp}ip_no_pmtu_disc" "0"
write "${tcp}tcp_ecn" "1"
write "${tcp}tcp_timestamps" "0"
write "${tcp}route.flush" "1"
write "${tcp}tcp_rfc1337" "1"
write "${tcp}tcp_tw_reuse" "1"
write "${tcp}tcp_sack" "1"
write "${tcp}tcp_fack" "1"
write "${tcp}tcp_fastopen" "3"
write "${tcp}tcp_tw_recycle" "1"
write "${tcp}tcp_syncookies" "0"
write "${tcp}tcp_window_scaling" "1"
write "${tcp}tcp_keepalive_probes" "10"
write "${tcp}tcp_keepalive_intvl" "30"
write "${tcp}tcp_fin_timeout" "30"
write "${tcp}tcp_low_latency" "1"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          CALIBRATING TOUCH...                                                                                   "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Touch calibration
panel=$(cat /sys/class/graphics/fb0/modes)
if [ "${panel:5:1}" == "x" ]; then
panel=${panel:2:3}
else
panel=${panel:2:4}
fi

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          DISABLING LPM...                                                                                       "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Disable LPM in gaming profile / performance profile
for lpm in /sys/module/lpm_levels/parameters/
do
if [[ -d /sys/module/lpm_levels ]]
then
write "${lpm}sleep_disabled" "Y"
fi
done

kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                         ENABLING FORCE FAST CHARGING...                                                                         "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# Enable Fast Charging Rate
for ffc in /sys/kernel/fast_charge/
do
if [[ -e "/sys/kernel/fast_charge/force_fast_charge" ]]
then
write "${ffc}force_fast_charge" "1"
fi
done
  
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                          KILLING GMS PROCESSES...                                                                               "
kmsg "-------------------------------------------------------------------------------------------------------------------------------------------------"

# GMS blocker 1.2 by @pedroginkgo
busybox killall -9 com.google.android.gms
busybox killall -9 com.google.android.gms.persistent
busybox killall -9 com.google.process.gapps
busybox killall -9 com.google.android.gsf
busybox killall -9 com.google.android.gsf.persistent

kmsg "------------------------------------------------------------------------------------------------------------------------------------------------"
kmsg "                                     GAMING PROFILE APPLIED WITH SUCCESS.                                                                       "
kmsg "------------------------------------------------------------------------------------------------------------------------------------------------"
vibrate_cmode
};;
esac
done
exit 0